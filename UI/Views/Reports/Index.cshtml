@{
    ViewData["Title"] = "Reports";
}

<div class="max-w-7xl mx-auto px-6 md:px-12 lg:px-20 pt-24">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="font-sans text-4xl font-semibold text-obsidian tracking-tight">Reports & Analytics</h1>
        <p class="text-subtle text-base mt-2">View statistics and export data</p>
    </div>

    <!-- Export Options -->
    <div class="premium-card rounded-xl overflow-hidden mb-8">
        <div class="px-8 py-6 border-b border-border/50">
            <h3 class="text-xl font-semibold text-obsidian">Export Options</h3>
        </div>
        <div class="px-8 py-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-obsidian mb-2">Start Date</label>
                    <input type="date" class="w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-obsidian/20 bg-white" id="startDate">
                </div>
                <div>
                    <label class="block text-sm font-medium text-obsidian mb-2">End Date</label>
                    <input type="date" class="w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-obsidian/20 bg-white" id="endDate">
                </div>
                <div class="flex items-end">
                    <button onclick="exportCSV()" class="w-full group relative isolate overflow-hidden bg-emerald-600 text-white text-sm font-semibold px-6 py-3 rounded shadow-[0_1px_2px_rgba(0,0,0,0.08)] ring-1 ring-white/10 transition-all duration-500 ease-[cubic-bezier(0.25,1,0.5,1)] hover:scale-[1.02] hover:shadow-[0_8px_24px_-4px_rgba(0,0,0,0.25)] hover:ring-white/20 active:scale-[0.98]">
                        <span class="relative z-10">ðŸ“¥ Export to CSV</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <div class="premium-card rounded-xl overflow-hidden">
            <div class="px-8 py-6 border-b border-border/50 bg-blue-50">
                <h3 class="text-xl font-semibold text-obsidian">Overall Statistics</h3>
            </div>
            <div class="px-8 py-6" id="overallStats">
                <p class="text-subtle">Loading...</p>
            </div>
        </div>
        <div class="premium-card rounded-xl overflow-hidden">
            <div class="px-8 py-6 border-b border-border/50 bg-emerald-50">
                <h3 class="text-xl font-semibold text-obsidian">Articles by Status</h3>
            </div>
            <div class="px-8 py-6">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Category Statistics -->
    <div class="premium-card rounded-xl overflow-hidden mb-8">
        <div class="px-8 py-6 border-b border-border/50 bg-yellow-50">
            <h3 class="text-xl font-semibold text-obsidian">Category Statistics</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="border-b border-border/50 bg-canvas">
                    <tr>
                        <th class="text-left px-8 py-4 font-semibold text-obsidian">Category</th>
                        <th class="text-left px-8 py-4 font-semibold text-obsidian">Total Articles</th>
                        <th class="text-left px-8 py-4 font-semibold text-obsidian">Published</th>
                        <th class="text-left px-8 py-4 font-semibold text-obsidian">Publish Rate</th>
                    </tr>
                </thead>
                <tbody id="categoryBody">
                    <tr><td colspan="4" class="text-center text-subtle py-8">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(ViewData["PowerBiEmbedUrl"]?.ToString()))
    {
        <div class="premium-card rounded-xl overflow-hidden">
            <div class="px-8 py-6 border-b border-border/50 bg-obsidian text-white">
                <h3 class="text-xl font-semibold">@ViewData["PowerBiTitle"]</h3>
            </div>
            <div class="p-8">
                <div class="aspect-video w-full">
                    <iframe src="@ViewData["PowerBiEmbedUrl"]" title="Power BI Dashboard" allowfullscreen class="w-full h-full rounded-lg"></iframe>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
        });

        let statsCache = null;
        let statsCacheTime = null;
        const CACHE_DURATION = 60000; // 1 minute

        function loadStatistics() {
            // Check cache
            if (statsCache && statsCacheTime && (Date.now() - statsCacheTime) < CACHE_DURATION) {
                renderStatistics(statsCache);
                return;
            }

            document.getElementById('overallStats').innerHTML = '<p class="text-subtle">Loading...</p>';
            
            const token = window.getAuthToken();
            Promise.all([
                fetch(window.API_BASE_URL + '/api/reports/statistics/overview', {
                    headers: {
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                }).then(response => {
                    if (!response.ok) throw new Error('Failed to load statistics');
                    return response.json();
                }),
                fetch(window.API_BASE_URL + '/api/reports/statistics/by-category', {
                    headers: {
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                }).then(response => {
                    if (!response.ok) throw new Error('Failed to load category statistics');
                    return response.json();
                })
            ])
                .then(([statsData, categoryData]) => {
                    // Cache the data
                    statsCache = { stats: statsData, categories: categoryData };
                    statsCacheTime = Date.now();
                    
                    renderStatistics(statsData, categoryData);
                })
                .catch(error => {
                    console.error('Error loading statistics:', error);
                    document.getElementById('overallStats').innerHTML = '<p class="text-red-600">Error loading statistics</p>';
                });
        }

        function renderStatistics(data, categoryData) {
            if (!data) return;
            
            const statsHtml = `
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-subtle">Total Articles:</span>
                                <span class="text-obsidian font-semibold">${data.totalArticles || 0}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-subtle">Published:</span>
                                <span class="text-emerald-600 font-semibold">${data.publishedArticles || 0}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-subtle">Pending Approval:</span>
                                <span class="text-yellow-600 font-semibold">${data.pendingArticles || 0}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-subtle">Draft:</span>
                                <span class="text-blue-600 font-semibold">${data.draftArticles || 0}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-subtle">Approved:</span>
                                <span class="text-blue-600 font-semibold">${data.approvedArticles || 0}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-subtle">Archived:</span>
                                <span class="text-gray-600 font-semibold">${data.archivedArticles || 0}</span>
                            </div>
                        </div>
                    `;
            document.getElementById('overallStats').innerHTML = statsHtml;
            createStatusChart(data);
            
            // Render category data if provided
            if (categoryData) {
                const tbody = document.getElementById('categoryBody');
                tbody.innerHTML = '';

                if (Array.isArray(categoryData) && categoryData.length > 0) {
                    categoryData.forEach(cat => {
                        tbody.innerHTML += `
                            <tr class="border-b border-border/30 hover:bg-canvas/50 transition-colors">
                                <td class="px-8 py-4 text-obsidian font-medium">${cat.categoryName || 'N/A'}</td>
                                <td class="px-8 py-4 text-subtle">${cat.articleCount || 0}</td>
                                <td class="px-8 py-4 text-subtle">${cat.publishedCount || 0}</td>
                                <td class="px-8 py-4 text-subtle">${(cat.publishRate || 0).toFixed(1)}%</td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-subtle py-8">No data available</td></tr>';
                }
            }
        }

        function createStatusChart(data) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Draft', 'Pending', 'Approved', 'Published', 'Archived'],
                    datasets: [{
                        data: [
                            data.draftArticles || 0,
                            data.pendingArticles || 0,
                            data.approvedArticles || 0,
                            data.publishedArticles || 0,
                            data.archivedArticles || 0
                        ],
                        backgroundColor: [
                            '#6c757d',
                            '#ffc107',
                            '#17a2b8',
                            '#28a745',
                            '#212529'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function exportCSV() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            let url = window.API_BASE_URL + '/api/reports/news-articles/export';
            if (startDate || endDate) {
                url += '?';
                if (startDate) url += `startDate=${startDate}`;
                if (endDate) url += `${startDate ? '&' : ''}endDate=${endDate}`;
            }

            const token = window.getAuthToken();
            
            // Use fetch to download with Authorization header
            fetch(url, {
                headers: {
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to export CSV');
                return response.blob();
            })
            .then(blob => {
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `news-articles-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
            })
            .catch(err => {
                alert('Error exporting CSV: ' + err.message);
            });
        }
    </script>
}
