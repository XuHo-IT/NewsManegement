@inject IConfiguration Configuration
@{
    ViewData["Title"] = "News Articles";
}

<div class="max-w-7xl mx-auto px-6 md:px-12 lg:px-20 pt-24">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
        <div>
            <h1 class="font-sans text-4xl font-semibold text-obsidian tracking-tight">News Articles</h1>
            <p class="text-subtle text-base mt-2">Manage your news content</p>
        </div>
        @if (Context.Session.GetString("UserRole") == "Staff")
        {
            <button class="group relative isolate overflow-hidden bg-black hover:bg-gray-800 text-white text-sm font-semibold px-6 py-3 rounded-lg shadow-md transition-all duration-300 hover:shadow-lg active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-obsidian/20 focus:ring-offset-2" data-bs-toggle="modal" data-bs-target="#articleModal" onclick="openCreateArticle()">
                <span class="relative z-10">Create Article</span>
            </button>
        }
    </div>

    <!-- Filters and Search -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <input type="text" id="searchInput" class="px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-obsidian/20 bg-white" placeholder="Search by title...">
        <div class="flex gap-2">
            <button class="flex-1 px-4 py-3 bg-black hover:bg-gray-800 text-white rounded-lg font-medium text-sm transition-colors shadow-sm hover:shadow-md" onclick="searchArticles()">Search</button>
            <button class="flex-1 px-4 py-3 bg-black hover:bg-gray-800 text-white rounded-lg font-medium text-sm transition-colors shadow-sm hover:shadow-md" onclick="resetFilters()">Reset</button>
        </div>
    </div>

    <!-- Status Filters -->
    <div class="flex flex-wrap gap-2 mb-8">
        <a href="@Url.Action("Index", new { filter = "all" })" class="px-4 py-2 rounded-lg font-medium text-sm bg-white border border-border hover:border-obsidian hover:bg-canvas transition-all">All</a>
        @if (Context.Session.GetString("UserRole") == "Staff")
        {
            <a href="@Url.Action("Index", new { filter = "draft" })" class="px-4 py-2 rounded-lg font-medium text-sm bg-white border border-border hover:border-obsidian hover:bg-canvas transition-all">Draft</a>
        }
        @if (Context.Session.GetString("UserRole") == "Admin")
        {
            <a href="@Url.Action("Index", new { filter = "pending" })" class="px-4 py-2 rounded-lg font-medium text-sm bg-white border border-border hover:border-obsidian hover:bg-canvas transition-all">Pending</a>
        }
        <a href="@Url.Action("Index", new { filter = "published" })" class="px-4 py-2 rounded-lg font-medium text-sm bg-white border border-border hover:border-obsidian hover:bg-canvas transition-all">Published</a>
    </div>

    <!-- Articles Table -->
    <div class="premium-card rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="border-b border-border/50 bg-canvas">
                    <tr>
                        <th class="text-left px-6 py-4 font-semibold text-obsidian">Image</th>
                        <th class="text-left px-6 py-4 font-semibold text-obsidian">Title</th>
                        <th class="text-left px-6 py-4 font-semibold text-obsidian">Category</th>
                        <th class="text-left px-6 py-4 font-semibold text-obsidian">Status</th>
                        <th class="text-left px-6 py-4 font-semibold text-obsidian">Author</th>
                        <th class="text-left px-6 py-4 font-semibold text-obsidian">Date</th>
                        <th class="text-left px-6 py-4 font-semibold text-obsidian">Actions</th>
                    </tr>
                </thead>
                <tbody id="articlesBody">
                    <tr><td colspan="7" class="text-center text-subtle py-8">Loading articles...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Article Modal -->
<div class="modal fade" id="articleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content premium-card border border-border" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header border-b border-border/50 px-8 py-6 sticky top-0 bg-white" style="z-index: 1059;">
                <h5 class="modal-title text-xl font-semibold text-obsidian" id="articleModalTitle">Create Article</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-8 py-6" style="position: relative; z-index: 1058;">
                <input type="hidden" id="articleId" />
                <div class="mb-4" id="articleNewsIdContainer">
                    <label class="block text-sm font-medium text-obsidian mb-2">Article ID *</label>
                    <input type="text" class="w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-obsidian/20 bg-white" id="articleNewsId" required autocomplete="off" style="position: relative; z-index: 1060;" />
                </div>
                <div class="mb-4" id="articleTitleContainer">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-obsidian">Title *</label>
                        <button type="button" class="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors" onclick="generateTitleWithAI()">✨ AI Generate</button>
                    </div>
                    <input type="text" class="w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-obsidian/20 bg-white" id="articleTitle" required autocomplete="off" style="position: relative; z-index: 1060;" />
                    <div id="aiTitleSuggestion" class="mt-2 hidden"></div>
                </div>
                <div class="mb-4" id="articleHeadlineContainer">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-obsidian">Headline *</label>
                        <button type="button" class="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors" onclick="generateHeadlineWithAI()">✨ AI Generate</button>
                    </div>
                    <input type="text" class="w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-obsidian/20 bg-white" id="articleHeadline" maxlength="150" required autocomplete="off" style="position: relative; z-index: 1060;" />
                    <div id="aiHeadlineSuggestion" class="mt-2 hidden"></div>
                </div>
                <div class="mb-4" id="articleContentContainer">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-obsidian">Content *</label>
                        <div class="flex gap-2">
                            <button type="button" class="text-xs px-3 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors" onclick="checkGrammarWithAI()">✓ Check Grammar</button>
                            <button type="button" class="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors" onclick="generateContentWithAI()">✨ Generate Content</button>
                        </div>
                    </div>
                    <div id="articleContentEditor" style="position: relative; z-index: 1060; min-height: 300px;"></div>
                    <textarea id="articleContent" style="display: none;" required></textarea>
                    <div id="aiContentSuggestions" class="mt-2 space-y-2"></div>
                </div>
                <div class="mb-4" id="articleImageContainer">
                    <label class="block text-sm font-medium text-obsidian mb-2">Image</label>
                    <input type="file" class="w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-obsidian/20 bg-white" id="articleImage" accept="image/*" style="position: relative; z-index: 1060;">
                    <small class="text-subtle text-xs">Upload article image (optional)</small>
                    <div id="articleCurrentImage" class="mt-2"></div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4" id="articleCategorySourceContainer">
                    <div>
                        <label class="block text-sm font-medium text-obsidian mb-2">Category *</label>
                        <select class="w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-obsidian/20 bg-white" id="articleCategory" required style="position: relative; z-index: 1060;"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-obsidian mb-2">Source</label>
                        <input type="text" class="w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-obsidian/20 bg-white" id="articleSource" autocomplete="off" style="position: relative; z-index: 1060;" />
                    </div>
                </div>
                <div class="mb-4" id="articleTagsContainer">
                    <label class="block text-sm font-medium text-obsidian mb-2">Tags</label>
                    <select class="w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-obsidian/20 bg-white" id="articleTags" multiple style="position: relative; z-index: 1060;"></select>
                    <small class="text-subtle text-xs">Hold Ctrl to select multiple</small>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-obsidian mb-2">Status</label>
                    <select class="w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-obsidian/20 bg-white" id="articleStatus" required style="position: relative; z-index: 1060;"></select>
                    <small class="text-subtle text-xs" id="statusHelpText"></small>
                </div>
            </div>
            <div class="modal-footer border-t border-border/50 px-8 py-6 sticky bottom-0 bg-white" style="z-index: 1059;">
                <button type="button" class="px-6 py-2.5 border border-border rounded-lg font-medium text-sm hover:bg-canvas transition-colors" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="group relative isolate overflow-hidden bg-black hover:bg-gray-800 text-white text-sm font-semibold px-6 py-2.5 rounded-lg shadow-md transition-all duration-300 hover:shadow-lg active:scale-[0.98]" onclick="saveArticle()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ✅ Rich Text Editor Instance
        let articleContentEditor = null;

        // Initialize TinyMCE Rich Text Editor
        function initRichTextEditor() {
            if (typeof tinymce !== 'undefined' && !articleContentEditor) {
                tinymce.init({
                    selector: '#articleContentEditor',
                    height: 500,
                    menubar: true,
                    plugins: [
                        // Core editing features
                        'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'link', 'lists', 'media', 'searchreplace', 'table', 'visualblocks', 'wordcount',
                        // Premium features (free trial until Feb 18, 2026)
                        'checklist', 'mediaembed', 'casechange', 'formatpainter', 'pageembed', 'a11ychecker', 'tinymcespellchecker', 'permanentpen', 'powerpaste', 'advtable', 'advcode', 'advtemplate', 'ai', 'uploadcare', 'mentions', 'tinycomments', 'tableofcontents', 'footnotes', 'mergetags', 'autocorrect', 'typography', 'inlinecss', 'markdown', 'importword', 'exportword', 'exportpdf'
                    ],
                    toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography uploadcare | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat | code fullscreen',
                    content_style: 'body { font-family: Arial, sans-serif; font-size: 14px; }',
                    z_index: 1060,
                    tinycomments_mode: 'embedded',
                    tinycomments_author: 'Article Author',
                    mergetags_list: [
                        { value: 'Article.Title', title: 'Article Title' },
                        { value: 'Article.Date', title: 'Article Date' },
                    ],
                    ai_request: (request, respondWith) => respondWith.string(() => Promise.reject('See docs to implement AI Assistant')),
                    uploadcare_public_key: '@(Configuration["TinyMCE:ApiKey"] ?? "cbco3op6631aqlq9ezt9tnymspw386pav8hbkf9xswyhuu7q")',
                    setup: function(editor) {
                        articleContentEditor = editor;
                        // Sync content to hidden textarea for form submission
                        editor.on('change keyup', function() {
                            document.getElementById('articleContent').value = editor.getContent();
                        });
                    }
                });
            }
        }

        // Destroy TinyMCE instance
        function destroyRichTextEditor() {
            if (articleContentEditor) {
                tinymce.remove('#articleContentEditor');
                articleContentEditor = null;
            }
        }

        // Wait for Bootstrap to be available
        function waitForBootstrap(callback) {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                callback();
            } else {
                setTimeout(() => waitForBootstrap(callback), 50);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadArticles();
            
            // Ensure Bootstrap is available before using it
            waitForBootstrap(function() {
                // Bootstrap is now available
                
                // ✅ FIX: Tự động mở modal edit nếu có query parameter "edit"
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('edit');
                if (editId) {
                    setTimeout(() => {
                        openEditArticle(editId);
                    }, 500); // Delay để đảm bảo articles đã load
                }
            });
        });

        function loadArticles(searchQuery = '') {
            const filter = '@ViewData["Filter"]' || 'all';
            let endpoint = '/api/news-articles';
            let queryParams = [];

            // ✅ FIX: "all" không gửi filter, để API tự xử lý theo role
            if (filter === 'published') {
                endpoint = '/api/news-articles/public';
            } else if (filter === 'draft') {
                queryParams.push('$filter=NewsStatus eq 1');
            } else if (filter === 'pending') {
                queryParams.push('$filter=NewsStatus eq 2');
            }
            // "all" không thêm filter - API sẽ tự filter theo role

            // Add search filter if provided
            if (searchQuery && searchQuery.trim()) {
                const searchFilter = `contains(NewsTitle, '${searchQuery.trim().replace(/'/g, "''")}')`;
                if (queryParams.length > 0) {
                    queryParams[0] += ` and ${searchFilter}`;
                } else {
                    queryParams.push(`$filter=${searchFilter}`);
                }
            }

            if (queryParams.length > 0) {
                endpoint += '?' + queryParams.join('&');
            }

            const token = window.getAuthToken();
            fetch(window.API_BASE_URL + endpoint, {
                headers: {
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load articles');
                    return response.json();
                })
                .then(data => {
                    const tbody = document.getElementById('articlesBody');
                    tbody.innerHTML = '';

                    if (Array.isArray(data) && data.length > 0) {
                        const userRole = window.getUserRole();
                        const currentUserId = window.getCurrentAccountID();
                        
                        data.forEach(article => {
                            const statusMap = {
                                1: { text: 'Draft', color: 'bg-slate-100 text-slate-700' },
                                2: { text: 'Pending', color: 'bg-yellow-100 text-yellow-700' },
                                3: { text: 'Approved', color: 'bg-blue-100 text-blue-700' },
                                4: { text: 'Published', color: 'bg-emerald-100 text-emerald-700' },
                                5: { text: 'Archived', color: 'bg-gray-100 text-gray-700' }
                            };
                            const status = statusMap[article.newsStatus] || { text: 'Unknown', color: 'bg-gray-100 text-gray-700' };
                            const date = new Date(article.createdDate).toLocaleDateString();
                            
                            const imageUrl = article.imageUrl || article.ImageUrl || '';
                            const imageHtml = imageUrl 
                                ? `<img src="${imageUrl}" alt="${article.newsTitle || 'Article'}" class="w-32 h-32 object-cover rounded-lg shadow-md border-2 border-gray-200 hover:border-obsidian/30 transition-all" onerror="this.style.display='none'">`
                                : '<div class="w-32 h-32 bg-gray-200 rounded-lg flex items-center justify-center text-gray-400 text-xs border-2 border-gray-300">No Image</div>';
                            
                            const createdById = article.createdByID || article.CreatedByID;
                            // ✅ FIX: Staff chỉ có thể edit nếu có CreatedByID và là của mình, hoặc nếu là Admin
                            const canEdit = userRole === 'Admin' || (createdById && userRole === 'Staff' && createdById.toString() === currentUserId);
                            const editButton = canEdit 
                                ? `<button onclick="openEditArticle('${article.newsArticleID}')" class="text-blue-600 hover:text-blue-800 font-medium text-xs bg-transparent border-0 p-0 cursor-pointer">Edit</button>`
                                : '<span class="text-gray-400 text-xs">No permission</span>';
                            
                            tbody.innerHTML += `
                                <tr class="border-b border-border/30 hover:bg-canvas/50 transition-colors">
                                    <td class="px-6 py-4">${imageHtml}</td>
                                    <td class="px-6 py-4 text-obsidian font-medium"><a href="/NewsArticles/Details/${article.newsArticleID}" class="hover:underline">${article.newsTitle || 'N/A'}</a></td>
                                    <td class="px-6 py-4 text-subtle">${article.category?.categoryName || 'N/A'}</td>
                                    <td class="px-6 py-4"><span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${status.color}">${status.text}</span></td>
                                    <td class="px-6 py-4 text-subtle">${article.createdBy?.accountName || 'N/A'}</td>
                                    <td class="px-6 py-4 text-subtle text-xs">${date}</td>
                                    <td class="px-6 py-4 flex gap-2">
                                        ${editButton}
                                        ${userRole === 'Admin' ? `<button onclick="deleteArticle('${article.newsArticleID}')" class="text-red-600 hover:text-red-800 font-medium text-xs bg-transparent border-0 p-0 cursor-pointer">Delete</button>` : ''}
                                    </td>
                                </tr>
                            `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-subtle py-8">No articles found</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('articlesBody').innerHTML = '<tr><td colspan="7" class="text-center text-red-600 py-8">Error loading data</td></tr>';
                });
        }

        function searchArticles() {
            const searchQuery = document.getElementById('searchInput').value;
            loadArticles(searchQuery);
        }

        // Allow Enter key to trigger search
        document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchArticles();
            }
        });

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            loadArticles();
        }

        function deleteArticle(id) {
            if (!confirm('Are you sure you want to delete this article?')) return;
            
            const token = window.getAuthToken();
            fetch(`${window.API_BASE_URL}/api/news-articles/${id}`, {
                method: 'DELETE',
                headers: {
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to delete article');
                loadArticles();
            })
            .catch(err => {
                alert('Error: ' + err.message);
            });
        }

        function populateStatusDropdown(selectElement, currentStatus = null, isEdit = false) {
            const userRole = window.getUserRole();
            selectElement.innerHTML = '';
            
            if (userRole === 'Admin') {
                // Admin có thể chọn tất cả status
                selectElement.innerHTML = `
                    <option value="1" ${currentStatus == 1 ? 'selected' : ''}>Draft</option>
                    <option value="2" ${currentStatus == 2 ? 'selected' : ''}>Pending</option>
                    <option value="3" ${currentStatus == 3 ? 'selected' : ''}>Approved</option>
                    <option value="4" ${currentStatus == 4 ? 'selected' : ''}>Published</option>
                `;
                document.getElementById('statusHelpText').textContent = '';
            } else {
                // Staff chỉ có thể chọn Draft hoặc Pending
                selectElement.innerHTML = `
                    <option value="1" ${currentStatus == 1 ? 'selected' : ''}>Draft</option>
                    <option value="2" ${currentStatus == 2 ? 'selected' : ''}>Pending</option>
                `;
                if (isEdit && (currentStatus == 3 || currentStatus == 4)) {
                    // Nếu đã được duyệt, disable dropdown
                    selectElement.disabled = true;
                    document.getElementById('statusHelpText').textContent = 'This article has been approved/published and cannot be modified.';
                    document.getElementById('statusHelpText').className = 'text-subtle text-xs text-red-600';
                } else {
                    selectElement.disabled = false;
                    document.getElementById('statusHelpText').textContent = 'Staff can only set status to Draft or Pending.';
                    document.getElementById('statusHelpText').className = 'text-subtle text-xs';
                }
            }
        }

        function openCreateArticle() {
            document.getElementById('articleModalTitle').textContent = 'Create Article';
            document.getElementById('articleId').value = '';
            document.getElementById('articleNewsId').value = '';
            document.getElementById('articleTitle').value = '';
            document.getElementById('articleHeadline').value = '';
            document.getElementById('articleContent').value = '';
            document.getElementById('articleSource').value = '';
            document.getElementById('articleCategory').value = '';
            document.getElementById('articleTags').selectedIndex = -1;
            document.getElementById('articleImage').value = '';
            document.getElementById('articleCurrentImage').innerHTML = '';
            
            // ✅ Initialize Rich Text Editor
            setTimeout(() => {
                initRichTextEditor();
                if (articleContentEditor) {
                    articleContentEditor.setContent('');
                }
            }, 100);
            
            // Show all fields for create (only Staff can create)
            document.getElementById('articleNewsIdContainer').style.display = 'block';
            document.getElementById('articleTitleContainer').style.display = 'block';
            document.getElementById('articleHeadlineContainer').style.display = 'block';
            document.getElementById('articleContentContainer').style.display = 'block';
            document.getElementById('articleImageContainer').style.display = 'block';
            document.getElementById('articleCategorySourceContainer').style.display = 'block';
            document.getElementById('articleTagsContainer').style.display = 'block';
            
            // Populate status dropdown based on role
            const statusSelect = document.getElementById('articleStatus');
            populateStatusDropdown(statusSelect, 1, false);
            
            // Load categories and tags before showing modal - same as edit
            const token = window.getAuthToken();
            Promise.all([
                fetch(`${window.API_BASE_URL}/api/categories`, {
                    headers: {
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                }).then(r => r.json()),
                fetch(`${window.API_BASE_URL}/api/tags`, {
                    headers: {
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                }).then(r => r.json())
            ])
            .then(([categories, tags]) => {
                // Populate categories dropdown
                const categorySelect = document.getElementById('articleCategory');
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                if (Array.isArray(categories)) {
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.categoryID;
                        option.textContent = cat.categoryName;
                        categorySelect.appendChild(option);
                    });
                }
                
                // Populate tags dropdown
                const tagSelect = document.getElementById('articleTags');
                tagSelect.innerHTML = '';
                if (Array.isArray(tags)) {
                    tags.forEach(tag => {
                        const option = document.createElement('option');
                        option.value = tag.tagID;
                        option.textContent = tag.tagName;
                        tagSelect.appendChild(option);
                    });
                }
                
                // Show modal after data is loaded - same as edit
                waitForBootstrap(function() {
                    const modalElement = document.getElementById('articleModal');
                    const modal = bootstrap.Modal.getOrCreateInstance(modalElement, {
                        backdrop: false // Disable backdrop completely
                    });
                    modal.show();
                });
            })
            .catch(err => {
                console.error('Error loading categories/tags:', err);
                // Still show modal even if loading fails
                waitForBootstrap(function() {
                    const modalElement = document.getElementById('articleModal');
                    const modal = bootstrap.Modal.getOrCreateInstance(modalElement, {
                        backdrop: false // Disable backdrop completely
                    });
                    modal.show();
                });
            });
        }

        function openEditArticle(id) {
            console.log('Opening edit for article ID:', id);
            document.getElementById('articleModalTitle').textContent = 'Edit Article';
            const token = window.getAuthToken();
            
            if (!id) {
                alert('Article ID is missing');
                return;
            }
            
            // Load categories and tags first, then load article data
            Promise.all([
                fetch(`${window.API_BASE_URL}/api/categories`, {
                    headers: {
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                }).then(r => {
                    if (!r.ok) throw new Error('Failed to load categories');
                    return r.json();
                }),
                fetch(`${window.API_BASE_URL}/api/tags`, {
                    headers: {
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                }).then(r => {
                    if (!r.ok) throw new Error('Failed to load tags');
                    return r.json();
                }),
                fetch(`${window.API_BASE_URL}/api/news-articles/${encodeURIComponent(id)}`, {
                    headers: {
                        ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                }).then(r => {
                    if (!r.ok) {
                        return r.text().then(text => {
                            console.error('API Error Response:', r.status, text);
                            throw new Error(`Failed to load article: ${r.status} ${r.statusText}`);
                        });
                    }
                    return r.json();
                })
            ])
            .then(([categories, tags, article]) => {
                // Populate categories dropdown
                const categorySelect = document.getElementById('articleCategory');
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                if (Array.isArray(categories)) {
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.categoryID;
                        option.textContent = cat.categoryName;
                        categorySelect.appendChild(option);
                    });
                }
                
                // Populate tags dropdown
                const tagSelect = document.getElementById('articleTags');
                tagSelect.innerHTML = '';
                if (Array.isArray(tags)) {
                    tags.forEach(tag => {
                        const option = document.createElement('option');
                        option.value = tag.tagID;
                        option.textContent = tag.tagName;
                        tagSelect.appendChild(option);
                    });
                }
                
                // ✅ FIX: Admin chỉ edit status, Staff edit full
                const userRole = window.getUserRole();
                const isAdmin = userRole === 'Admin';
                
                // Disable/enable fields based on role
                document.getElementById('articleNewsIdContainer').style.display = isAdmin ? 'none' : 'block';
                document.getElementById('articleTitleContainer').style.display = isAdmin ? 'none' : 'block';
                document.getElementById('articleHeadlineContainer').style.display = isAdmin ? 'none' : 'block';
                document.getElementById('articleContentContainer').style.display = isAdmin ? 'none' : 'block';
                document.getElementById('articleImageContainer').style.display = isAdmin ? 'none' : 'block';
                document.getElementById('articleCategorySourceContainer').style.display = isAdmin ? 'none' : 'block';
                document.getElementById('articleTagsContainer').style.display = isAdmin ? 'none' : 'block';
                
                // Now set article values - handle both camelCase and PascalCase
                document.getElementById('articleId').value = article.newsArticleID || article.NewsArticleID || '';
                document.getElementById('articleNewsId').value = article.newsArticleID || article.NewsArticleID || '';
                document.getElementById('articleTitle').value = article.newsTitle || article.NewsTitle || '';
                document.getElementById('articleHeadline').value = article.headline || article.Headline || '';
                const articleContent = article.newsContent || article.NewsContent || '';
                document.getElementById('articleSource').value = article.newsSource || article.NewsSource || '';
                document.getElementById('articleCategory').value = article.categoryID || article.CategoryID || '';
                const currentStatus = article.newsStatus || article.NewsStatus || 1;
                document.getElementById('articleImage').value = '';
                
                // ✅ Set content to Rich Text Editor
                setTimeout(() => {
                    initRichTextEditor();
                    if (articleContentEditor) {
                        articleContentEditor.setContent(articleContent);
                    } else {
                        // Fallback if editor not ready
                        document.getElementById('articleContent').value = articleContent;
                    }
                }, 100);
                
                // Populate status dropdown based on role and current status
                const statusSelect = document.getElementById('articleStatus');
                populateStatusDropdown(statusSelect, currentStatus, true);
                
                // Show current image if available - check both camelCase and PascalCase
                const imageUrl = article.imageUrl || article.ImageUrl;
                console.log('Article data:', article);
                console.log('Image URL:', imageUrl);
                if (imageUrl) {
                    document.getElementById('articleCurrentImage').innerHTML = 
                        `<img src="${imageUrl}" alt="Current image" class="rounded-lg" style="max-width: 200px; max-height: 150px; object-fit: cover;">`;
                } else {
                    document.getElementById('articleCurrentImage').innerHTML = '';
                }
                
                // Set tags selection
                if (article.tags && Array.isArray(article.tags)) {
                    Array.from(tagSelect.options).forEach(option => {
                        option.selected = article.tags.some(t => t.tagID == option.value || t.tagID == parseInt(option.value));
                    });
                }
                
                // Show modal - same as categories/tags
                waitForBootstrap(function() {
                    const modalElement = document.getElementById('articleModal');
                    const modal = bootstrap.Modal.getOrCreateInstance(modalElement, {
                        backdrop: false // Disable backdrop completely
                    });
                    modal.show();
                });
            })
            .catch(err => {
                console.error('Error loading article:', err);
                console.error('Article ID:', id);
                console.error('API URL:', `${window.API_BASE_URL}/api/news-articles/${id}`);
                console.error('Token:', token ? 'Present' : 'Missing');
                alert('Error loading article: ' + err.message + '\n\nPlease check console for details.');
            });
        }

        function loadCategoriesForModal() {
            const token = window.getAuthToken();
            fetch(`${window.API_BASE_URL}/api/categories`, {
                headers: {
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                }
            })
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('articleCategory');
                select.innerHTML = '<option value="">Select Category</option>';
                if (Array.isArray(data)) {
                    data.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.categoryID;
                        option.textContent = cat.categoryName;
                        select.appendChild(option);
                    });
                }
            });
        }

        function loadTagsForModal() {
            const token = window.getAuthToken();
            fetch(`${window.API_BASE_URL}/api/tags`, {
                headers: {
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                }
            })
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('articleTags');
                select.innerHTML = '';
                if (Array.isArray(data)) {
                    data.forEach(tag => {
                        const option = document.createElement('option');
                        option.value = tag.tagID;
                        option.textContent = tag.tagName;
                        select.appendChild(option);
                    });
                }
            });
        }

        function saveArticle() {
            const id = document.getElementById('articleId').value;
            const userRole = window.getUserRole();
            const isAdmin = userRole === 'Admin';
            const token = window.getAuthToken();
            
            const formData = new FormData();
            
            if (isAdmin && id) {
                // ✅ FIX: Admin chỉ gửi status khi edit
                formData.append('NewsStatus', document.getElementById('articleStatus').value);
            } else {
                // Staff hoặc Create - gửi đầy đủ
                const selectedTags = Array.from(document.getElementById('articleTags').selectedOptions).map(opt => parseInt(opt.value));
                const imageFile = document.getElementById('articleImage').files[0];
                
                // ✅ Get content from Rich Text Editor
                let content = '';
                if (articleContentEditor) {
                    content = articleContentEditor.getContent();
                } else {
                    content = document.getElementById('articleContent').value;
                }
                
                formData.append('NewsArticleID', document.getElementById('articleNewsId').value);
                formData.append('NewsTitle', document.getElementById('articleTitle').value);
                formData.append('Headline', document.getElementById('articleHeadline').value);
                formData.append('NewsContent', content); // ✅ Use content from rich text editor
                formData.append('NewsSource', document.getElementById('articleSource').value);
                formData.append('CategoryID', document.getElementById('articleCategory').value);
                formData.append('NewsStatus', document.getElementById('articleStatus').value);
                selectedTags.forEach(tagId => formData.append('TagIds', tagId));
                
                if (imageFile) {
                    formData.append('image', imageFile);
                }
            }

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${window.API_BASE_URL}/api/news-articles/${id}` : `${window.API_BASE_URL}/api/news-articles`;

            fetch(url, {
                method: method,
                headers: {
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Failed to save article');
                    });
                }
                return response.status === 204 ? null : response.json();
            })
            .then(() => {
                loadArticles();
                // ✅ Destroy editor when closing modal
                destroyRichTextEditor();
                waitForBootstrap(function() {
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById('articleModal'));
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                });
            })
            .catch(err => alert(err.message));
        }
        
        // ✅ Clean up editor when modal is closed
        document.addEventListener('DOMContentLoaded', function() {
            const articleModal = document.getElementById('articleModal');
            if (articleModal) {
                articleModal.addEventListener('hidden.bs.modal', function() {
                    destroyRichTextEditor();
                });
            }
        });

        // ✅ AI Integration Functions
        function generateTitleWithAI() {
            // ✅ Get content from Rich Text Editor
            let content = '';
            if (articleContentEditor) {
                content = articleContentEditor.getContent({ format: 'text' }).trim();
            } else {
                content = document.getElementById('articleContent').value.trim();
            }
            if (!content) {
                alert('Please enter article content first');
                return;
            }

            const suggestionDiv = document.getElementById('aiTitleSuggestion');
            suggestionDiv.innerHTML = '<div class="text-xs text-gray-500">Generating title...</div>';
            suggestionDiv.classList.remove('hidden');

            window.apiFetch('/api/ai/generate-title', {
                method: 'POST',
                body: JSON.stringify({ content: content })
            })
            .then(r => r.json())
            .then(data => {
                const title = data.generatedTitle || data.suggestedTitle || '';
                if (title) {
                    suggestionDiv.innerHTML = `
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-sm font-medium text-blue-900 mb-2">AI Suggestion:</p>
                            <p class="text-sm text-blue-700 mb-2">"${title}"</p>
                            <button onclick="useAISuggestion('articleTitle', '${title.replace(/'/g, "\\'")}')" class="text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Use This</button>
                            <button onclick="document.getElementById('aiTitleSuggestion').classList.add('hidden')" class="text-xs px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 ml-2">Dismiss</button>
                        </div>
                    `;
                }
            })
            .catch(err => {
                suggestionDiv.innerHTML = `<div class="text-xs text-red-500">Error: ${err.message}</div>`;
            });
        }

        function generateHeadlineWithAI() {
            // ✅ Get content from Rich Text Editor
            let content = '';
            if (articleContentEditor) {
                content = articleContentEditor.getContent({ format: 'text' }).trim();
            } else {
                content = document.getElementById('articleContent').value.trim();
            }
            if (!content) {
                alert('Please enter article content first');
                return;
            }

            const suggestionDiv = document.getElementById('aiHeadlineSuggestion');
            suggestionDiv.innerHTML = '<div class="text-xs text-gray-500">Generating headline...</div>';
            suggestionDiv.classList.remove('hidden');

            window.apiFetch('/api/ai/generate-summary', {
                method: 'POST',
                body: JSON.stringify({ content: content })
            })
            .then(r => r.json())
            .then(data => {
                const summary = data.generatedSummary || data.suggestedSummary || '';
                const headline = summary.substring(0, 150); // Headline max 150 chars
                if (headline) {
                    suggestionDiv.innerHTML = `
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-sm font-medium text-blue-900 mb-2">AI Suggestion:</p>
                            <p class="text-sm text-blue-700 mb-2">"${headline}"</p>
                            <button onclick="useAISuggestion('articleHeadline', '${headline.replace(/'/g, "\\'")}')" class="text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Use This</button>
                            <button onclick="document.getElementById('aiHeadlineSuggestion').classList.add('hidden')" class="text-xs px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 ml-2">Dismiss</button>
                        </div>
                    `;
                }
            })
            .catch(err => {
                suggestionDiv.innerHTML = `<div class="text-xs text-red-500">Error: ${err.message}</div>`;
            });
        }

        function checkGrammarWithAI() {
            // ✅ Get content from Rich Text Editor
            let content = '';
            if (articleContentEditor) {
                content = articleContentEditor.getContent({ format: 'text' }).trim();
            } else {
                content = document.getElementById('articleContent').value.trim();
            }
            if (!content) {
                alert('Please enter article content first');
                return;
            }

            const suggestionsDiv = document.getElementById('aiContentSuggestions');
            suggestionsDiv.innerHTML = '<div class="text-xs text-gray-500 p-2">Checking grammar...</div>';

            window.apiFetch('/api/ai/check-grammar', {
                method: 'POST',
                body: JSON.stringify({ content: content })
            })
            .then(r => r.json())
            .then(data => {
                const issues = data.grammarIssues ? (typeof data.grammarIssues === 'string' ? JSON.parse(data.grammarIssues) : data.grammarIssues) : [];
                if (issues.length > 0) {
                    let html = '<div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg"><p class="text-sm font-medium text-yellow-900 mb-2">Grammar Issues Found:</p><ul class="text-sm text-yellow-700 list-disc list-inside">';
                    issues.forEach(issue => {
                        html += `<li>${issue}</li>`;
                    });
                    html += '</ul><button onclick="document.getElementById(\'aiContentSuggestions\').innerHTML = \'\'" class="text-xs px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 mt-2">Dismiss</button></div>';
                    suggestionsDiv.innerHTML = html;
                } else {
                    suggestionsDiv.innerHTML = '<div class="p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-700">✓ No grammar issues detected!</div>';
                }
            })
            .catch(err => {
                suggestionsDiv.innerHTML = `<div class="text-xs text-red-500">Error: ${err.message}</div>`;
            });
        }

        function generateContentWithAI() {
            // ✅ Get content from Rich Text Editor (input của người dùng)
            let userInput = '';
            if (articleContentEditor) {
                userInput = articleContentEditor.getContent({ format: 'text' }).trim();
            } else {
                userInput = document.getElementById('articleContent').value.trim();
            }
            
            if (!userInput) {
                alert('Please enter some content or topic first to generate article content');
                return;
            }

            const suggestionsDiv = document.getElementById('aiContentSuggestions');
            suggestionsDiv.innerHTML = '<div class="text-xs text-gray-500 p-2">Generating content based on your input...</div>';

            window.apiFetch('/api/ai/generate-content', {
                method: 'POST',
                body: JSON.stringify({ 
                    input: userInput,
                    title: document.getElementById('articleTitle').value || ''
                })
            })
            .then(r => r.json())
            .then(data => {
                const generatedContent = data.generatedContent || data.content || '';
                if (generatedContent) {
                    // Escape HTML để hiển thị an toàn
                    const escapedContent = generatedContent.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    // Escape cho JavaScript string
                    const contentForJS = generatedContent.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/\r/g, '');
                    
                    let html = '<div class="p-3 bg-blue-50 border border-blue-200 rounded-lg"><p class="text-sm font-medium text-blue-900 mb-2">AI Generated Content:</p>';
                    html += '<div class="text-sm text-blue-700 mb-3 p-2 bg-white rounded border border-blue-100 max-h-60 overflow-y-auto whitespace-pre-wrap">' + escapedContent.replace(/\n/g, '<br>') + '</div>';
                    html += '<div class="flex gap-2"><button onclick="useAIGeneratedContent(\'' + contentForJS + '\')" class="text-xs px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Use This Content</button>';
                    html += '<button onclick="document.getElementById(\'aiContentSuggestions\').innerHTML = \'\'" class="text-xs px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Dismiss</button></div></div>';
                    suggestionsDiv.innerHTML = html;
                } else {
                    suggestionsDiv.innerHTML = '<div class="p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700">No content generated. Please try again.</div>';
                }
            })
            .catch(err => {
                suggestionsDiv.innerHTML = `<div class="text-xs text-red-500">Error: ${err.message}</div>`;
            });
        }
        
        function useAIGeneratedContent(content) {
            if (articleContentEditor) {
                // Set content vào TinyMCE editor
                articleContentEditor.setContent(content);
                // Sync với hidden textarea
                document.getElementById('articleContent').value = content;
            } else {
                document.getElementById('articleContent').value = content;
            }
            // Clear suggestions
            document.getElementById('aiContentSuggestions').innerHTML = '';
        }


        function useAISuggestion(fieldId, value) {
            document.getElementById(fieldId).value = value;
            document.getElementById('aiTitleSuggestion').classList.add('hidden');
            document.getElementById('aiHeadlineSuggestion').classList.add('hidden');
        }

        function useAITags(tags) {
            // This would need to match tags by name and select them in the dropdown
            // For now, just show a message
            alert('Tags suggested: ' + tags.join(', ') + '\\nPlease select matching tags from the dropdown manually.');
            document.getElementById('aiContentSuggestions').innerHTML = '';
        }
    </script>
}
