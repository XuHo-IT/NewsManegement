@{
    ViewData["Title"] = "Article Details";
}

<div class="max-w-5xl mx-auto px-6 md:px-12 lg:px-20 pt-24 pb-20">
    <!-- Back Button -->
    <div class="mb-6">
        <a href="@Url.Action("Index", "NewsArticles")" class="inline-flex items-center gap-2 text-subtle hover:text-obsidian transition-colors text-sm font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m12 19-7-7 7-7"></path>
                <path d="M19 12H5"></path>
            </svg>
            Back to Articles
        </a>
    </div>

    <!-- Article Card -->
    <div class="premium-card rounded-xl overflow-hidden" id="articleCard">
        <!-- Article Header with Image -->
        <div id="articleImageContainer" class="hidden w-full h-64 bg-canvas overflow-hidden">
            <img id="articleImage" src="" alt="Article image" class="w-full h-full object-cover">
        </div>

        <div class="p-8 md:p-12">
            <!-- Status and Category Badges -->
            <div class="flex flex-wrap items-center gap-3 mb-6">
                <span id="articleStatus" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium">Loading...</span>
                <span id="articleCategory" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-canvas text-subtle">Loading...</span>
            </div>

            <!-- Title -->
            <h1 id="articleTitle" class="font-sans text-4xl md:text-5xl font-bold text-obsidian tracking-tight mb-4 leading-tight">
                Loading...
            </h1>

            <!-- Headline -->
            <p id="articleHeadline" class="text-xl text-subtle mb-8 leading-relaxed">
                Loading...
            </p>

            <!-- Meta Information -->
            <div class="flex flex-wrap items-center gap-6 pb-8 mb-8 border-b border-border/50 text-sm text-subtle">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span id="articleAuthor">Loading...</span>
                </div>
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span id="articleDate">Loading...</span>
                </div>
                <div id="articleSourceContainer" class="flex items-center gap-2 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path>
                    </svg>
                    <span id="articleSource">N/A</span>
                </div>
            </div>

            <!-- Content -->
            <div class="prose prose-lg max-w-none mb-8">
                <div id="articleContent" class="article-content text-obsidian leading-relaxed">
                    Loading...
                </div>
            </div>

            <!-- Tags -->
            <div id="articleTagsContainer" class="mb-8">
                <h3 class="text-sm font-semibold text-obsidian mb-3">Tags</h3>
                <div id="articleTags" class="flex flex-wrap gap-2">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-canvas text-subtle">No tags</span>
                </div>
            </div>

            <!-- Action Buttons - Only show for creator or Admin -->
            <div id="articleActions" class="flex flex-wrap gap-3 pt-8 border-t border-border/50 hidden">
                <button onclick="editArticle()" class="group relative isolate overflow-hidden bg-obsidian hover:bg-gray-800 text-white text-sm font-semibold px-6 py-3 rounded-lg shadow-md transition-all duration-300 hover:shadow-lg active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-obsidian/20 focus:ring-offset-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    <span>Edit Article</span>
                </button>
                <button onclick="deleteArticle()" class="px-6 py-3 border-2 border-red-300 hover:border-red-400 text-red-600 hover:text-red-700 text-sm font-semibold rounded-lg transition-all duration-300 hover:bg-red-50 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-red-200 focus:ring-offset-2">
                    Delete Article
                </button>
                <button id="submitForApprovalBtn" onclick="submitForApproval()" class="px-6 py-3 border-2 border-blue-300 hover:border-blue-400 text-blue-600 hover:text-blue-700 text-sm font-semibold rounded-lg transition-all duration-300 hover:bg-blue-50 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-blue-200 focus:ring-offset-2 hidden">
                    Submit for Approval
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const articleId = window.location.pathname.split('/').pop();
        const userRole = window.getUserRole();
        const currentUserId = window.getCurrentAccountID();

        document.addEventListener('DOMContentLoaded', function() {
            loadArticleDetails();
        });

        function loadArticleDetails() {
            const token = window.getAuthToken();
            fetch(`${window.API_BASE_URL}/api/news-articles/${articleId}`, {
                headers: {
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load article');
                    return response.json();
                })
                .then(article => {
                    // Basic info
                    document.getElementById('articleTitle').textContent = article.newsTitle || article.NewsTitle || 'N/A';
                    document.getElementById('articleHeadline').textContent = article.headline || article.Headline || 'N/A';
                    
                    // Content - handle HTML content
                    const content = article.newsContent || article.NewsContent || 'N/A';
                    const contentDiv = document.getElementById('articleContent');
                    if (content.includes('<') || content.includes('&lt;')) {
                        contentDiv.innerHTML = content;
                    } else {
                        contentDiv.innerHTML = content.replace(/\n/g, '<br>');
                    }
                    
                    // Author
                    const authorName = article.createdBy?.accountName || article.CreatedBy?.AccountName || 'N/A';
                    document.getElementById('articleAuthor').textContent = authorName;
                    
                    // Category
                    const categoryName = article.category?.categoryName || article.Category?.CategoryName || 'N/A';
                    document.getElementById('articleCategory').textContent = categoryName;
                    
                    // Date
                    const createdDate = article.createdDate || article.CreatedDate;
                    if (createdDate) {
                        document.getElementById('articleDate').textContent = new Date(createdDate).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                    
                    // Source
                    const source = article.newsSource || article.NewsSource;
                    if (source) {
                        document.getElementById('articleSource').textContent = source;
                        document.getElementById('articleSourceContainer').classList.remove('hidden');
                    }
                    
                    // Image
                    const imageUrl = article.imageUrl || article.ImageUrl;
                    if (imageUrl) {
                        document.getElementById('articleImage').src = imageUrl;
                        document.getElementById('articleImageContainer').classList.remove('hidden');
                    }
                    
                    // Status badge
                    const status = article.newsStatus || article.NewsStatus || 1;
                    const statusBadge = document.getElementById('articleStatus');
                    const statusInfo = getStatusInfo(status);
                    statusBadge.textContent = statusInfo.text;
                    statusBadge.className = `inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusInfo.color}`;

                    // Tags
                    const tags = article.tags || article.Tags || [];
                    const tagsContainer = document.getElementById('articleTags');
                    if (tags.length > 0) {
                        tagsContainer.innerHTML = tags
                            .map(tag => `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">${tag.tagName || tag.TagName}</span>`)
                            .join('');
                    } else {
                        tagsContainer.innerHTML = '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-canvas text-subtle">No tags</span>';
                    }

                    // ✅ FIX: Chỉ cho phép người tạo mới có quyền xóa/sửa (hoặc Admin)
                    const createdById = article.createdByID || article.CreatedByID;
                    const canEdit = userRole === 'Admin' || (createdById && createdById.toString() === currentUserId);
                    
                    if (canEdit) {
                        document.getElementById('articleActions').classList.remove('hidden');
                        
                        // Chỉ hiện "Submit for Approval" nếu status là Draft và là Staff
                        if (status === 1 && userRole === 'Staff') {
                            document.getElementById('submitForApprovalBtn').classList.remove('hidden');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('articleCard').innerHTML = 
                        '<div class="p-8 text-center"><div class="text-red-600 font-medium">Error loading article</div></div>';
                });
        }

        function getStatusInfo(status) {
            const statuses = {
                1: { text: 'Draft', color: 'bg-slate-100 text-slate-700' },
                2: { text: 'Pending', color: 'bg-yellow-100 text-yellow-700' },
                3: { text: 'Approved', color: 'bg-blue-100 text-blue-700' },
                4: { text: 'Published', color: 'bg-emerald-100 text-emerald-700' },
                5: { text: 'Archived', color: 'bg-gray-100 text-gray-700' }
            };
            return statuses[status] || { text: 'Unknown', color: 'bg-gray-100 text-gray-700' };
        }

        function editArticle() {
            // Redirect to articles page and trigger edit modal
            window.location.href = `@Url.Action("Index", "NewsArticles")?edit=${articleId}`;
        }

        function deleteArticle() {
            if (!confirm('Are you sure you want to delete this article? This action cannot be undone.')) return;

            const token = window.getAuthToken();
            fetch(`${window.API_BASE_URL}/api/news-articles/${articleId}`, {
                method: 'DELETE',
                headers: {
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Article deleted successfully');
                    window.location.href = '@Url.Action("Index", "NewsArticles")';
                } else {
                    return response.text().then(text => {
                        throw new Error(text || 'Error deleting article');
                    });
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }

        function submitForApproval() {
            const token = window.getAuthToken();
            fetch(`${window.API_BASE_URL}/api/v2/news-articles/${articleId}/submit`, {
                method: 'POST',
                headers: {
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Article submitted for approval');
                    location.reload();
                } else {
                    return response.text().then(text => {
                        throw new Error(text || 'Error submitting article');
                    });
                }
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
    </script>
}

<style>
    .article-content {
        line-height: 1.8;
        font-size: 1.1rem;
        color: #111111;
        word-wrap: break-word;
    }
    .article-content img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 1rem 0;
    }
    .article-content p {
        margin-bottom: 1rem;
    }
    .article-content h1, .article-content h2, .article-content h3 {
        margin-top: 2rem;
        margin-bottom: 1rem;
        font-weight: 600;
    }
</style>
